#!/usr/bin/env bash

# Update package list
sudo apt-get update

# Install HAProxy
sudo apt-get install -y haproxy

# Configure HAProxy
echo "frontend lb-frontend" | sudo tee -a /etc/haproxy/haproxy.cfg
echo "    bind *:80" | sudo tee -a /etc/haproxy/haproxy.cfg
echo "    mode http" | sudo tee -a /etc/haproxy/haproxy.cfg
echo "    default_backend lb-backend" | sudo tee -a /etc/haproxy/haproxy.cfg

echo "backend lb-backend" | sudo tee -a /etc/haproxy/haproxy.cfg
echo "    mode http" | sudo tee -a /etc/haproxy/haproxy.cfg
echo "    balance roundrobin" | sudo tee -a /etc/haproxy/haproxy.cfg
echo "    server web-01 54.175.198.8 check" | sudo tee -a /etc/haproxy/haproxy.cfg
echo "    server web-02 54.175.198.8 check" | sudo tee -a /etc/haproxy/haproxy.cfg

# Enable HAProxy to be managed via init script
sudo sed -i 's/ENABLED=0/ENABLED=1/' /etc/default/haproxy

# Restart HAProxy to apply the configuration
sudo service haproxy restart
